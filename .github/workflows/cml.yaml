name: ML Pipeline with DVC & CML

on: [push]

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install dvc scikit-learn pandas matplotlib
        npm install -g @dvcorg/cml

    - name: Cache DVC files
      uses: actions/cache@v3
      with:
        path: .dvc/cache
        key: dvc-cache-${{ hashFiles('**/*.dvc') }}
        restore-keys: |
          dvc-cache-

    - name: Pull data with DVC
      run: |
        dvc pull --allow-missing

    - name: Reproduce model
      run: |
        python src/train.py

    - name: CML reports
      env:
        REPO_TOKEN: ${{ secrets.CML_TOKEN }}
      run: |
        echo "## Logistics Demand Forecasting Report" >> report.md
        cat metrics/metrics.json >> report.md
        cml-publish plots/demand.png --md >> report.md
        cml-send-comment report.md

